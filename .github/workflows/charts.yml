name: charts

on:
  pull_request:
    paths:
      - deploy/**
      - .github/workflows/charts.yml
      - README.md
  push:
    branches:
      - master
      - stable
    paths:
      - deploy/**
      - .github/workflows/charts.yml
      - README.md

jobs:
  helm-validate:
    name: Helm chart validation
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Lint chart
        run: helm lint deploy/charts/roadrunner

      - name: Render chart with default values
        run: helm template roadrunner deploy/charts/roadrunner > /tmp/roadrunner-default.yaml

      - name: Assert Gateway API resources are default
        run: |
          grep -n "kind: Gateway" /tmp/roadrunner-default.yaml
          grep -n "kind: HTTPRoute" /tmp/roadrunner-default.yaml
          if grep -n "kind: Ingress" /tmp/roadrunner-default.yaml; then
            echo "Ingress should not render by default"
            exit 1
          fi

      - name: Render chart with Argo CD example values
        run: helm template roadrunner deploy/charts/roadrunner -f deploy/argocd/values.yaml > /tmp/roadrunner-argocd.yaml

      - name: Render chart in ingress compatibility mode
        run: |
          helm template roadrunner deploy/charts/roadrunner \
            --set gateway.enabled=false \
            --set ingress.enabled=true > /tmp/roadrunner-ingress.yaml
          grep -n "kind: Ingress" /tmp/roadrunner-ingress.yaml

      - name: Assert invalid Gateway backend configuration fails
        run: |
          if helm template roadrunner deploy/charts/roadrunner --set ports.http.service=false >/tmp/roadrunner-invalid.yaml 2>/tmp/roadrunner-invalid.err; then
            echo "Expected template rendering to fail"
            exit 1
          fi
          grep -n "gateway.route.enabled=true requires ports.http.service=true" /tmp/roadrunner-invalid.err
